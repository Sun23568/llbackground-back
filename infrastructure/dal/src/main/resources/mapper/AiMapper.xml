<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.llback.dal.ai.dao.AiDao">
    <!-- 新增AI配置 -->
    <insert id="insertAiConfig" parameterType="com.llback.dal.ai.po.AiConfigPo">
        INSERT INTO ai_config (
            pk_id, menu_code, ollama_model_id,
            comfy_ui_url, ollama_url, comfy_file_id,
            background_image, context_size, create_time, update_time
        ) VALUES (
            #{pkId}, #{menuCode}, #{ollamaModelId},
            #{comfyUiUrl}, #{ollamaUrl}, #{comfyFileId},
            #{backgroundImage}, #{contextSize}, #{createTime}, #{updateTime}
        )
    </insert>

    <!-- 更新AI配置 -->
    <update id="updateAiConfig" parameterType="com.llback.dal.ai.po.AiConfigPo">
        UPDATE ai_config
        SET ollama_model_id = #{ollamaModelId},
            comfy_ui_url = #{comfyUiUrl},
            ollama_url = #{ollamaUrl},
            comfy_file_id = #{comfyFileId},
            background_image = #{backgroundImage},
            context_size = #{contextSize},
            update_time = #{updateTime}
        WHERE menu_code = #{menuCode}
    </update>

    <!-- 根据菜单代码查询AI配置 -->
    <select id="queryConfigByMenuCode" resultType="com.llback.dal.ai.po.AiConfigPo">
        SELECT
            T1.pk_id,
            T1.menu_code,
            T2.MENU_NAME as menu_name,
            T1.ollama_model_id,
            T1.comfy_ui_url,
            T1.ollama_url,
            T1.comfy_file_id,
            T1.background_image,
            T1.context_size,
            T1.create_time,
            T1.update_time
        FROM ai_config T1
        LEFT JOIN SYS_MENU T2 ON T1.menu_code = T2.MENU_CODE
        WHERE T1.menu_code = #{menuCode}
    </select>

    <!-- 查询所有AI菜单配置 -->
    <select id="queryAllConfig" resultType="com.llback.dal.ai.po.AiConfigPo">
        SELECT
            T1.pk_id,
            T1.menu_code,
            T2.MENU_NAME as menu_name,
            T1.ollama_model_id,
            T1.comfy_ui_url,
            T1.ollama_url,
            T1.comfy_file_id,
            T1.background_image,
            T1.context_size,
            T1.create_time,
            T1.update_time
        FROM ai_config T1
        LEFT JOIN SYS_MENU T2 ON T1.menu_code = T2.MENU_CODE
        ORDER BY T1.create_time DESC
    </select>

    <!-- 更新背景图片 -->
    <update id="updateBackgroundImage">
        UPDATE ai_config
        SET background_image = #{backgroundImage},
            update_time = NOW()
        WHERE menu_code = #{menuCode}
    </update>

    <!-- 根据AI菜单代码查询配置 -->
    <select id="queryConfig" resultType="com.llback.dal.ai.po.AiConfigPo">
        SELECT
            T1.pk_id,
            T1.menu_code,
            T2.MENU_NAME as menu_name,
            T1.ollama_model_id,
            T1.comfy_ui_url,
            T1.ollama_url,
            T1.comfy_file_id,
            T1.background_image,
            T1.context_size,
            T1.create_time,
            T1.update_time
        FROM ai_config T1
        LEFT JOIN SYS_MENU T2 ON T1.menu_code = T2.MENU_CODE
        WHERE T1.menu_code = #{aiMenuId}
    </select>
</mapper>
